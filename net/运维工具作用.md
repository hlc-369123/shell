#### 运维工具作用

 		该工具是通过管理节点获取集群的IP信息，对集群中所有存储节点或者单个节点进行网络及资源的状态检测。

#### 可调整参数

```bash
#时间同步的检测值,单位为毫秒.
CHECK_TIME_VALUE='500'
#OSD使用率告警检测值.
CHECK_OSD_USAGE='75'
#系统负载告警检测值.
SYS_LOAD="75"
#系统盘inode使用率告警检测值.
SYS_USE="65"
#系统cpu告警检测值.
CPU_USE="90"
#系统负载告警检测值.
MEMORY_USE="96"
#系统ssh端口号
ssh_port="22"
```

#### 文件所在位置

- 运行中产生的检测文件和检测日志将会存放在“/tmp/operations/”目录下；
- 运行完成之后，若有异常将会在该目录下产生“result_cluster_warn.log”错误信息汇总；
- 更多检测过程中的详细日志信息，在相应运行节点该目录下的“check_dir”目录下面；
- 在“check_dir”目录下产生三个可执行的shell文件“check_network.sh” “check_resource.sh” “get_result.sh”；

#### 运行日志信息

- Info：记录工具运行过程中的正常日志信息，通常随系统颜色输出在屏幕上面；
- warn：记录工具运行过程中非预期的异常输出，通常会以红底白字的形式输出在屏幕上面；

​	    Info和warn信息都有时间和相应的告警级别，执行过程中异常退出的告警信息将不会输入到日志文件中，检测中的异常信息将会输入到相应的日志文件中。

#### 所在节点检测

​		判断当前运行的节点是否为管理节点，正常情况下可以通过“xms-manage db list”的输出确认是否为管理节点，若判断成功且符合以下两个条件，则为正常；

- 若使用token方式需要所在管理节点数据库状态正常，且能执行查询命令；
- 运行工具的节点必须和被检测节点已经开启免密；

#### 运行时可选参数

- 默认情况下无序添加任何参数，通过输入SDS UI用户名/密码的方式运行；
- 可通过“-t”/“--token”的选项，无需用户名/密码直接运行；
- 其他参数，将会输出该工具的功能选项信息；

#### 获取集群ip

​		获取集群中的"ADMIN_IP" "PUBLIC_IP" "PRIVATE_IP" "GATEWAY_IPS"，并保存到工具运行所在节点“/tmp/operations/net”目录下；

#### 功能模块

- Cluster_network：该模块默认将会调用检查集群中存储节点 **admin/public/cluster** 三个网络；
- Get_res：该模块默认将会调用检查集群中存储节点资源情况；
- Custom_IP：该模块通过指定集群中的一个节点进行网路和资源的检查；
- Clean_env：清理“/tmp/operations/”下的运行时保存的ip信息、检查文件和日志文件；
- Quit：退出，终止运行；

​    选择非退出模块的情况下，选择非以上功能3次将会终止运行。

##### 运行前

​		默认情况下，将获取到的管理网路的ip作为检查的网段：

1. 测试获取的ip是否可以ping通；
2. 测试获取的ip是否可以免密登陆；
3. 进行分发运行过程中所需脚本及ip信息；

##### 网络检测

分别检测"ADMIN_IP" "PUBLIC_IP" "PRIVATE_IP"

- 判断ip列表中的信息是否存在检测节点的ip，若没有则可能网络或者网卡存在异常将会提示告警信息并跳过该网络的检查；
- 若存在本节点ip，将使用本节点的ip和集群中所有存储节点相同功能ip进行检测；
- 若到某个节点网络不通或者出现丢包则进行告警提示，否则不进行输出；
- 若只检测单个节点需要输入集群中的管理网的ip，输入的ip会进行合法性检测；

- [ ] 判断是否以点分割的四段数字；
- [ ] 判断每段数字范围是否小于255；
- [ ] 判断该ip是否存在集群中；

##### 资源检测

- #Swap status（判断标准：是否开启）;
- #System load（判断标准：当前或15分钟之内，是否超过定义的检测值）;
- #System disk use and disk inode（判断标准：当前根分区空间或inode使用率，是否超过定义的检测值）;
- #System cpu use（判断标准：当前用户或者系统占用cpu的使用率，是否超过定义的检测值）;
- **#Memory**（判断标准：当前系统(1-空闲/总内存)*100，是否超过定义的检测值）;
- #Firewalld（判断标准：当前系统iptables/firewalld是否开启）;
- #SELINUX（判断标准：当前系统selinux状态是否为Disabled状态）;
- #Service（判断标准：当前系统"network" "docker" "xmsd" "xdc"是否为active状态）;
- 时间同步（判断标准：逐节点检测timedatectl status|awk '/synchronized/'是否为yes，否则clockdiff是否超过定义的检测值）；
- ceph集群状态（判断标准：若不为"HEALTH_OK"状态则输出当前的告警信息）；
- osd使用率（判断标准：使用率超过定义的检测值则会输出osd信息）；

##### 结果收集

​		逐节点检测是否存在告警信息，若存在告警信息则会输出节点和告警信息，若无告警则不进行输出；